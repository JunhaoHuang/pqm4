//  ntt32.c
//  Copyright (c) 2023 Raccoon Signature Team. See LICENSE.

//  === 32-bit Number Theoretic Transform

#include <stddef.h>
#include <stdbool.h>
#include "hal.h"
#include <stdio.h>
#include "polyr.h"
#include "mont32.h"
#include "mont64.h"

typedef uint32_t uint32;

static void printbytes(const unsigned char *x, unsigned long long xlen)
{
    char outs[2 * xlen + 1];
    unsigned long long i;
    for (i = 0; i < xlen; i++)
        sprintf(outs + 2 * i, "%02X", x[i]);
    outs[2 * xlen] = 0;
    hal_send_str(outs);
}
//  === Roots of unity constants

/*
    (g is the smallest full generator for both q1 and q2)

    n   = 512
    q1  = 2^24-2^18+1
    q2  = 2^25-2^18+1
    q   = q1*q2
    r   = 2^64 % q
    r1  = 2^32 % q1
    r2  = 2^32 % q2
    g   = Mod(15, q)
    h   = g^(znorder(g)/(2*n))
    h1  = Mod(lift(h), q1)
    h2  = Mod(lift(h), q2)

    bitrev(n,i) = \
      b = binary(n + (i%n));\
      sum(i = 2, length(b), 2^(i-2) * b[i])

    Generating the Montgomery ("r1") and ("r2") scaled constants
    racc_w32_1[511] and racc_w32_2[511]:

    w1 = vector(511,i,lift(r1*h1^bitrev(n,i)))
    w2 = vector(511,i,lift(r2*h2^bitrev(n,i)))

    print them out

    for(i=1,511,printf("\t{%d, %d},", w1[i], w2[i]);if(i%3==0,printf("\n")))
*/
static const int32_t racc_w1_32[511] = {
    6459829, 6724791, 2854072, 2659044, 14713997, 14113155, 13853133, 2214999, 713782, 12189159, 13885804, 12118639, 16472663, 13975435, 15691979, 9507138, 2513236, 4580230, 13325401, 13264360, 16421508, 7465801, 14835457, 9534672, 3986098, 164372, 12020825, 2053709, 759182, 335953, 1160782, 7725862, 5235549, 6044843, 2999387, 13303838, 5379527, 11057583, 16442646, 10414489, 342049, 2248971, 1649313, 5959367, 6362504, 10472383, 2359291, 14068601, 10573718, 8592974, 8185132, 14785052, 1976795, 9932237, 15129302, 14607709, 11819643, 2017545, 15516096, 13739185, 16416870, 3643612, 10630888, 13065073, 13207150, 6641700, 3224575, 6980454, 8058453, 236196, 13178135, 16470624, 13727118, 6825156, 3119691, 15892217, 3127331, 15835742, 10111116, 9705449, 12955837, 1143885, 10229685, 1554252, 8155384, 6824996, 9448688, 11607389, 15856809, 11728448, 11532439, 14049335, 5332490, 9437148, 9940094, 61359, 1720349, 1945542, 1724483, 12882462, 3111340, 15935803, 4235249, 3240775, 763969, 14333122, 12411974, 3368434, 3738409, 8826952, 1544575, 10531868, 9464026, 10348034, 7799654, 1169657, 1096084, 4571137, 3795111, 15500529, 14773253, 15751114, 8006173, 12738660, 75912, 11924466, 15961082, 15575459, 16312641, 1231570, 12487358, 2037224, 6175327, 15654902, 8304598, 10940413, 1221020, 2287719, 6064884, 15335423, 6394777, 8087158, 14129134, 11326961, 906403, 917427, 163624, 1544720, 10726100, 2713142, 1323086, 5818536, 5436573, 8972798, 14147091, 3986583, 6891182, 1040958, 14487515, 15318946, 2411182, 8821128, 7315073, 15885217, 3393477, 11540938, 2099471, 14829730, 8195897, 12939571, 10891518, 12821598, 6067170, 13680548, 3844075, 13464713, 5750986, 9491296, 3861100, 3820108, 13338669, 5777431, 4144672, 7259309, 13287024, 7260395, 8932940, 7864418, 12028253, 7800124, 15444796, 15097370, 3399190, 10298911, 13805558, 11910139, 12603531, 15812918, 7090784, 525722, 7011384, 9106630, 5906664, 6772368, 13204966, 11123142, 4791249, 15311175, 8505792, 4308086, 8837295, 7616319, 4478976, 5754531, 7846505, 5066699, 6479637, 380454, 8910719, 10114174, 7914630, 3480539, 16486606, 5900516, 14021732, 2553609, 9592250, 3543258, 5698163, 7674692, 13456804, 10517817, 12116905, 10097918, 246849, 16113840, 4718606, 5053420, 10386621, 15620573, 5698103, 10338589, 15496172, 12049205, 14705438, 233571, 891635, 11134953, 8168963, 1511098, 11428769, 1293750, 15691160, 5766899, 9112705, 3461385, 11769602, 2749974, 10926459, 13696503, 10103004, 3257614, 8801227, 1813360, 3532076, 10123210, 10100239, 13876606, 10819237, 16451816, 15348184, 6660339, 10249677, 13856284, 7713214, 3877381, 10089980, 4574306, 4472065, 5974238, 14625582, 10376258, 7783518, 16514990, 6689401, 619116, 14756774, 14866413, 2946088, 6936450, 2634760, 4749457, 10321662, 1126179, 5212260, 11240507, 13847698, 9668828, 11417953, 13323795, 16214326, 7645780, 12612003, 14582530, 9573046, 8963574, 1644350, 5923010, 8419587, 4293933, 15731348, 11878204, 4687251, 11271718, 13656652, 6806179, 13386925, 5849341, 3345215, 12235184, 14613155, 10785538, 2980732, 5806441, 5448169, 1693548, 4255934, 5684718, 13742528, 2518115, 13329370, 15832424, 11096053, 3601885, 13505560, 2599878, 4383772, 385990, 11229401, 1833169, 6596262, 4034814, 8506689, 14062146, 6312887, 7794008, 974198, 3366379, 15353500, 12615014, 13525309, 8459615, 13920877, 11638972, 7969751, 5783292, 12703132, 11206276, 11699899, 10436920, 10960101, 9433646, 12423102, 3536472, 2247359, 13722220, 7789860, 6826300, 13192857, 8974319, 2391871, 7525685, 7292667, 13451270, 4171764, 10418725, 10731765, 299218, 1448609, 1693871, 12845647, 13186654, 6607446, 988035, 9785136, 8875784, 15410290, 10212134, 1642067, 4412106, 258145, 14603653, 4631726, 14364267, 7193418, 2665117, 5390369, 13583034, 14563469, 13002936, 767428, 6917856, 538876, 14156792, 12840464, 10165176, 15422112, 13378781, 16416947, 3803210, 306665, 7447608, 12257186, 16027140, 9430592, 15278760, 3061430, 16081830, 10607060, 11998945, 10670940, 12996671, 4473794, 15305124, 8495208, 1888429, 15159248, 1405022, 8025368, 14450720, 3684627, 9980742, 8590101, 15835063, 6933008, 5755569, 10345642, 15440114, 10393475, 1236076, 2907163, 5185732, 4468910, 4895133, 7972704, 3097528, 14482035, 9181809, 3892922, 7149565, 9230360, 2323078, 4055183, 6088802, 3493862, 529895, 591151, 12601228, 10340651, 11178734, 3111704, 15188896, 9479161, 7090104, 6956551, 5697674, 1245831, 9821948, 15599615, 11628557, 15844707, 10865149, 12274098, 10543667, 10426277, 14864097, 15698846, 9686719, 5504803, 14532946, 3984022, 3153814, 6613622, 13511929, 2615713, 5505714, 1655170, 12751629, 13592320, 7113000, 7954588, 7136375, 15913211, 801992, 2499974, 9127282, 1120091, 1996999, 11361625, 5064585, 13099982, 10577914, 10289669, 13982280, 7622456, 4015737, 4150089, 11926879, 13099524, 8341728, 7139762};
static const int32_t racc_w2_32[511] = {
    18304632, 7543113, 7433152, 10516699, 30041014, 12016999, 30119652, 25003819, 7062373, 4939132, 28572885, 27402401, 27260573, 25227641, 1699052, 23584536, 16900132, 2829345, 21662135, 11299231, 9488343, 20663113, 20614042, 17051604, 27372078, 11875826, 15152935, 27749958, 19414638, 14639878, 8428013, 17539385, 31212134, 16328186, 24184363, 28498243, 24092323, 22582647, 25731287, 11403006, 7289164, 1926796, 19241740, 8834508, 5015735, 5234908, 32245547, 10130955, 22308470, 5450924, 22839876, 403006, 9839231, 24442133, 4947299, 25177546, 22484191, 18488793, 116842, 6357874, 32862008, 14154844, 23872154, 18735062, 18328159, 11788671, 19484597, 3230630, 30533374, 22977545, 12768015, 846457, 27802498, 23026243, 28339012, 5642243, 19197405, 28664087, 20436312, 16991644, 9142167, 25162084, 16882607, 10219044, 1033849, 15369493, 21427015, 2798453, 31407969, 16558299, 11100836, 13514388, 11750397, 15183463, 31390971, 3690205, 25550194, 25611170, 30470884, 334634, 2837321, 28496418, 4978508, 32736283, 20888702, 16278794, 16212395, 4695507, 1750758, 6760130, 30285659, 5122156, 27441713, 14062271, 14420085, 26689043, 26365212, 16771475, 23485566, 29454327, 27161931, 32851742, 2144336, 6504132, 12154117, 20944052, 17934007, 14384724, 18472847, 19080737, 14395273, 12139621, 25192616, 27813450, 27753487, 8414681, 21677243, 12947324, 5391700, 20600271, 840503, 24210537, 27217272, 8542770, 18915968, 23752522, 4757196, 8326415, 4066115, 12843560, 226722, 22227227, 19269447, 84067, 4919274, 3607977, 3133026, 7065810, 25678085, 19859590, 5295285, 19895385, 3027303, 15457740, 24518905, 24574131, 12296673, 31605980, 4906188, 14099108, 7650520, 18914015, 21716563, 11483061, 7495071, 33011439, 602173, 11960669, 12055028, 22726698, 14653790, 2223715, 32513905, 926362, 25525289, 8812935, 16772554, 1103720, 31363210, 18705188, 24506803, 26213179, 31588038, 22623386, 30732081, 26502754, 31153860, 29811910, 20157716, 16133110, 700933, 33243631, 27261400, 17370981, 23562435, 16460624, 3305769, 13251893, 12133625, 31999666, 22483618, 17405866, 4010730, 6426366, 1899664, 10284450, 26408651, 27001711, 10483140, 22233305, 24003515, 12904817, 24834805, 5940897, 30118142, 2079905, 24498288, 15463836, 20229106, 8182961, 21031339, 22288090, 23150502, 8388731, 24897932, 6834477, 14126630, 14912019, 18132346, 1619174, 13452201, 9577605, 17473021, 17597750, 18599273, 13239791, 8886177, 9843456, 25148376, 2772912, 8994793, 23381116, 7545971, 22141026, 11428204, 8714786, 2462532, 10106905, 12592243, 12947949, 4640587, 2443992, 30611882, 5553419, 14987842, 1945751, 28955259, 5264857, 27308461, 19088878, 15105305, 15031281, 10851174, 15952833, 21116302, 3599602, 19856398, 11769977, 28740307, 29789489, 9442606, 14577539, 12073694, 32931525, 24037460, 7487648, 12565774, 6972290, 26739211, 21634722, 14347844, 25018769, 10402815, 20293655, 8597115, 10943150, 21825350, 7727370, 4074437, 5162670, 28717833, 20491807, 6650661, 27776321, 18147926, 25925207, 18163805, 7924792, 27774746, 18925322, 18461954, 9517491, 2464441, 2926065, 18087002, 19052850, 25057507, 27931455, 23634251, 8544621, 17597022, 27196855, 3575549, 9863708, 7947778, 10402959, 2667162, 13349263, 30416091, 9546618, 21207243, 27318421, 6469516, 9033833, 19823865, 28680807, 13126776, 2988456, 6868088, 9259841, 9809280, 2749909, 12615641, 15168416, 8244996, 2150793, 5677958, 18803214, 6151764, 2252928, 11841819, 28117011, 7155340, 6768109, 12333627, 22216219, 3947183, 12730841, 6622706, 11300381, 17428136, 3917613, 16516499, 7507568, 2742231, 11894516, 11601672, 4312728, 18686795, 12024439, 6796134, 31188053, 8630780, 8619954, 10214090, 13895612, 6803985, 18087074, 27563045, 25286329, 2867214, 25258840, 28552029, 15835705, 31319443, 15585909, 7545557, 2714668, 7186505, 27922344, 24622623, 30229135, 2148758, 10667779, 7479943, 14314799, 3962194, 9561457, 8061572, 6033676, 28775647, 32002897, 17375508, 19351181, 22197221, 260611, 23028189, 9479765, 20263442, 18141718, 3068838, 21390640, 15028368, 17169085, 4812752, 4871381, 26524309, 2074088, 5441160, 21946142, 13761919, 19809115, 2033976, 25344249, 643663, 15622808, 28880075, 685396, 10316037, 17559381, 12880965, 7122242, 14802322, 22401669, 22113106, 23780078, 25015122, 28752060, 31421498, 10290411, 6567132, 29946207, 19843571, 13856329, 22798690, 29919843, 30859467, 12767929, 16437343, 32761422, 691455, 30187676, 25179754, 6418749, 19629722, 28492891, 32708228, 7875335, 20946247, 6541367, 20407133, 33142871, 32762006, 25737367, 29237631, 29165600, 16775749, 27169550, 33194114, 25818405, 882609, 3857404, 28788596, 24207723, 28574912, 20650342, 14282046, 27541825, 14605849, 28192158, 15337026, 12622799, 26521052, 12970664, 12232455, 19081762, 9168373, 4245406, 29066697, 21054226, 20455998, 22327431, 7672038, 31898677, 29963997, 4591219, 11437979, 25728942, 743579, 19506115, 13275295, 9542626, 21263930, 28402557, 1282478, 16171986, 24134014, 9271102, 22217378, 19711414, 14671670};

//  2x32 CRT: Split into two-prime representation (in-place).
// instead of interleaving two coefficients modulo q1 and q2; we separately use a0...a511 mod q1 and a0...a511 mod q2: [a0...a511||a0...a511]. (not in-place)

void polyr2_split(int64_t *v)
{
    int64_t x;
    int32_t p1[RACC_N];
    int32_t *p0;

    p0 = (int32_t *)v;
    for(int i=0;i<RACC_N;i++) {
        x = v[i];
        p0[0] = mont32_redc1(x);
        p1[i] = mont32_redc2(x);
        p0 += 1;
    }

    for(int i=0;i<RACC_N;i++){
        p0[0] = p1[i];
        p0 += 1;
    }
}


//  2x32 CRT: Join two-prime into 64-bit integer representation (not in-place).
//  Use scale factors (s1, s2). Normalizes to 0 <= x < q.

void polyr2_join(int64_t *v, int32_t s1, int32_t s2)
{
    int64_t x;
    int64_t v1[RACC_N];

    int32_t x1, x2;
    int32_t *p0, *p1;

    p0 = (int32_t *)v;
    p1 = (int32_t *)(v + 256);

    for(int i=0;i<RACC_N;i++){
        x1 = mont32_cadd(mont32_mulq1(p0[i], s1), RACC_Q1);
        x2 = mont32_cadd(mont32_mulq2(p1[i], s2), RACC_Q2);

        x = (((int64_t)RACC_Q2) * ((int64_t)x1)) +
            (((int64_t)RACC_Q1) * ((int64_t)x2));

        //  we have [0,2q], put to [0,q-1]
        x = mont64_csub(x, RACC_Q);
        v1[i] = x;
    }
    for(int i=0;i<RACC_N;i++){
        v[i] = v1[i];
    }
}

//  2x32 CRT: Add polynomials:  r = a + b.

void polyr2_add(int64_t *r, const int64_t *a, const int64_t *b)
{
    size_t i;
    int32_t *r2 = (int32_t *)r;
    const int32_t *a2 = (const int32_t *)a;
    const int32_t *b2 = (const int32_t *)b;

    for (i = 0; i < (2 * RACC_N); i += 2) {
        r2[i + 0] = mont32_add(a2[i + 0], b2[i + 0]);
        r2[i + 1] = mont32_add(a2[i + 1], b2[i + 1]);
    }
}

//  2x32 CRT: Subtract polynomials:  r = a - b.

void polyr2_sub(int64_t *r, const int64_t *a, const int64_t *b)
{
    size_t i;
    int32_t *r2 = (int32_t *)r;
    const int32_t *a2 = (const int32_t *)a;
    const int32_t *b2 = (const int32_t *)b;

    for (i = 0; i < (2 * RACC_N); i += 2) {
        r2[i + 0] = mont32_sub(a2[i + 0], b2[i + 0]);
        r2[i + 1] = mont32_sub(a2[i + 1], b2[i + 1]);
    }
}

//  2x32 CRT: Add polynomials mod q1 and q2: r = a + b  (mod q).

void polyr_ntt_addq(int64_t *r, const int64_t *a, const int64_t *b)
{
    size_t i;
    int32_t *r2 = (int32_t *)r;
    const int32_t *a2 = (const int32_t *)a;
    const int32_t *b2 = (const int32_t *)b;

    for (i = 0; i < RACC_N; i++) {
        r2[i + 0] = mont32_csub(mont32_add(a2[i + 0], b2[i + 0]), RACC_Q1);
        r2[i + RACC_N] = mont32_csub(mont32_add(a2[i + RACC_N], b2[i + RACC_N]), RACC_Q2);
    }
}

//  2x32 CRT: Subtract polynomials mod q1 and q2: r = a - b (mod q).

void polyr_ntt_subq(int64_t *r, const int64_t *a, const int64_t *b)
{
    size_t i;
    int32_t *r2 = (int32_t *)r;
    const int32_t *a2 = (const int32_t *)a;
    const int32_t *b2 = (const int32_t *)b;

    for (i = 0; i < RACC_N; i ++) {
        r2[i + 0] = mont32_cadd(mont32_sub(a2[i + 0], b2[i + 0]), RACC_Q1);
        r2[i + RACC_N] = mont32_cadd(mont32_sub(a2[i + RACC_N], b2[i + RACC_N]), RACC_Q2);
    }
}

//  2x32 CRT: Scalar multiplication:    r = a * c,  Montgomery reduction.

void polyr_ntt_smul(int64_t *r, const int64_t *a, int32_t c1, int32_t c2)
{
    size_t i;
    int32_t *r2 = (int32_t *)r;
    const int32_t *a2 = (const int32_t *)a;

    for (i = 0; i < RACC_N; i++) {
        r2[i + 0] = mont32_cadd(mont32_mulq1(a2[i + 0], c1), RACC_Q1);
        r2[i + RACC_N] = mont32_cadd(mont32_mulq2(a2[i + RACC_N], c2), RACC_Q2);
    }
}

//  2x32 CRT: Coefficient multiply:  r = a * b,  Montgomery reduction.

void polyr_ntt_cmul(int64_t *r, const int64_t *a, const int64_t *b)
{
    size_t i;
    int32_t *r2 = (int32_t *)r;
    const int32_t *a2 = (const int32_t *)a;
    const int32_t *b2 = (const int32_t *)b;

    for (i = 0; i < RACC_N; i ++) {
        r2[i + 0] = mont32_mulq1(a2[i + 0], b2[i + 0]);
        r2[i + RACC_N] = mont32_mulq2(a2[i + RACC_N], b2[i + RACC_N]);
    }
}

//  2x32 CRT: Multiply and add:  r = a * b + c, Montgomery reduction.

void polyr_ntt_mula(int64_t *r, const int64_t *a, const int64_t *b,
                    const int64_t *c)
{
    size_t i;
    int32_t *r2 = (int32_t *)r;
    const int32_t *a2 = (const int32_t *)a;
    const int32_t *b2 = (const int32_t *)b;
    const int32_t *c2 = (const int32_t *)c;

    for (i = 0; i < RACC_N; i ++) {
        r2[i + 0] = mont32_csub(mont32_mulq1(a2[i + 0], b2[i + 0]) + c2[i + 0], RACC_Q1);
        r2[i + RACC_N] = mont32_csub(mont32_mulq2(a2[i + RACC_N], b2[i + RACC_N]) + c2[i + RACC_N], RACC_Q2);
    }
}

//  2x32 CRT: Forward NTT (x^n+1). Input is 64-bit, output is 2x32 CRT.

void polyr_fntt(int64_t *v)
{
    size_t i, j, k;
    int64_t x;
    int32_t x1, y1, z;
    int32_t *p0, *p1, *p2;
    int32_t v1[RACC_N];

    const int32_t *w1 = racc_w1_32;
    const int32_t *w2 = racc_w2_32;

    //  split

    p0 = (int32_t *)v;

    for(i=0;i<RACC_N;i++) {
        x = v[i];
        p0[i] = mont32_redc1(x);
        v1[i] = mont32_redc2(x);
    }

    //  NTT butterflies
    for (k = 1, j = RACC_N >> 1; j > 0; k <<= 1, j >>= 1) {
        p0 = (int32_t *)v;
        for (i=0;i<k;i++){
            z = *w1++;
            p1 = p0+j;
            p2 = p1+j;
            while(p1<p2){
                x1=*p0;
                y1=*p1;
                y1=mont32_mulq1(y1,z);
                *p0++=mont32_add(x1,y1);
                *p1++=mont32_sub(x1,y1);
            }
            p0=p2;
        }
    }
    for (k = 1, j = RACC_N >> 1; j > 0; k <<= 1, j >>= 1)
    {
        p0 = (int32_t *)v1;
        for (i = 0; i < k; i++)
        {
            z = *w2++;
            p1 = p0 + j;
            p2 = p1 + j;
            while (p1 < p2)
            {
                x1 = *p0;
                y1 = *p1;
                y1 = mont32_mulq2(y1, z);
                *p0++ = mont32_add(x1, y1);
                *p1++ = mont32_sub(x1, y1);
            }
            p0 = p2;
        }
    }
    p0=(int32_t*)(v+256);
    for(i=0;i<RACC_N;i++){
        p0[i]=v1[i];
    }
}

//  2x32 CRT: Inverse NTT (x^n+1).

void polyr_intt(int64_t *v)
{
    size_t i, j, k;
    int64_t x;
    int32_t x1, x2, y1, z;
    int32_t *p0, *p1, *p2;
    int64_t tmp[RACC_N];

    const int32_t *w1 = &racc_w1_32[RACC_N - 2];
    const int32_t *w2 = &racc_w2_32[RACC_N - 2];

    //  inverse butterflies

    for (j = 1, k = RACC_N >> 1; k > 0; j <<= 1, k >>= 1) {

        p0 = (int32_t *)v;

        for(i=0;i<k;i++){
            z=*w1--;
            p1=p0+j;
            p2=p1+j;

            while(p1<p2){
                x1=mont32_cadd(p0[0],RACC_Q1);
                y1=p1[0];
                *p0++ =mont32_csub(mont32_add(x1,y1),RACC_Q1);
                *p1++ =mont32_mulq1(mont32_sub(y1,x1),z);
            }
            p0=p2;
        }
    }
    for (j = 1, k = RACC_N >> 1; k > 0; j <<= 1, k >>= 1)
    {

        p0 = (int32_t *)(v + 256);

        for (i = 0; i < k; i++)
        {
            z = *w2--;
            p1 = p0 + j;
            p2 = p1 + j;

            while (p1 < p2)
            {
                x1 = mont32_cadd(p0[0], RACC_Q2);
                y1 = p1[0];
                *p0++ = mont32_csub(mont32_add(x1, y1), RACC_Q2);
                *p1++ = mont32_mulq2(mont32_sub(y1, x1), z);
            }
            p0 = p2;
        }
    }

    //  join & normalize
    p0 = (int32_t *)v;
    p1 = (int32_t *)(v + 256);

    for(i=0; i<RACC_N; i++) {
        x1 = mont32_cadd(mont32_mulq1(p0[i], MONT_C4Q1), RACC_Q1);
        x2 = mont32_cadd(mont32_mulq2(p1[i], MONT_C4Q2), RACC_Q2);

        x = (((int64_t)RACC_Q2) * ((int64_t)x1)) +
            (((int64_t)RACC_Q1) * ((int64_t)x2));

        //  we have [0,~2q], put to [0,q-1]
        x = mont64_csub(x, RACC_Q);

        tmp[i] = x;
    }
    for(i=0;i<RACC_N;i++){
        v[i]=tmp[i];
    }
}

